# SCC Vulnerability API

FastAPI application for querying GCP Security Command Center vulnerability data by appcode and LOB.

## Features

- **Query by Appcode**: Get all vulnerabilities for a specific application code (paginated)
- **Query by LOB**: Get all vulnerabilities for a specific Line of Business (paginated)
- **Filter Options**: Filter by severity (CRITICAL, HIGH, MEDIUM, LOW) and state (ACTIVE, INACTIVE)
- **Pagination**: All list endpoints support pagination to handle large datasets
- **Individual Lookup**: Get specific vulnerability details by finding ID
- **Statistics**: Get aggregated statistics by severity, appcode, LOB, and state
- **List Appcodes**: Get all unique appcodes with their vulnerability counts (paginated)
- **List LOBs**: Get all unique LOBs with their vulnerability counts (paginated)

## Installation

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Ensure your `.env.dev` or `.env.prod` file is configured with:
```
GCP_PROJECT_ID=your-project-id
FIRESTORE_VULNERABILITY_DB=cost-db
FIRESTORE_COLLECTION_VULNERABILITIES=scc-vulnerabilities-dev
```

3. Authenticate with GCP:
```bash
gcloud auth application-default login
```

## Running the API

### Development Mode (Windows)
```powershell
.\run_api.ps1
```

### Development Mode (Linux/Mac)
```bash
chmod +x run_api.sh
./run_api.sh
```

### Or run directly with Python
```bash
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Or with uvicorn
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

The API will be available at `http://localhost:8000`

## API Endpoints

### 1. Root Endpoint
```
GET /
```
Returns API information and available endpoints.

**Example:**
```bash
curl http://localhost:8000/
```

### 2. Health Check
```
GET /health
```
Check if the API and database connection are healthy.

**Example:**
```bash
curl http://localhost:8000/health
```

### 3. Get Vulnerabilities by Appcode (Paginated)
```
GET /vulnerabilities/by-appcode/{appcode}
```

**Query Parameters:**
- `severity` (optional): Filter by severity (CRITICAL, HIGH, MEDIUM, LOW)
- `state` (optional): Filter by state (ACTIVE, INACTIVE)
- `page` (optional): Page number, starts from 1 (default: 1)
- `page_size` (optional): Results per page (default: 100, max: 1000)

**Examples:**
```bash
# Get all vulnerabilities for appcode "APP001" (first page)
curl http://localhost:8000/vulnerabilities/by-appcode/APP001

# Get only CRITICAL vulnerabilities for appcode "APP001"
curl "http://localhost:8000/vulnerabilities/by-appcode/APP001?severity=CRITICAL"

# Get ACTIVE HIGH severity vulnerabilities with pagination
curl "http://localhost:8000/vulnerabilities/by-appcode/APP001?severity=HIGH&state=ACTIVE&page=1&page_size=50"

# Get page 2 with 100 results per page
curl "http://localhost:8000/vulnerabilities/by-appcode/APP001?page=2&page_size=100"
```

**Response includes pagination info:**
```json
{
  "vulnerabilities": [...],
  "pagination": {
    "page": 1,
    "page_size": 100,
    "total_results": 250,
    "total_pages": 3,
    "has_next": true,
    "has_previous": false
  },
  "filter_by": "appcode",
  "filter_value": "APP001"
}
```

### 4. Get Vulnerabilities by LOB (Paginated)
```
GET /vulnerabilities/by-lob/{lob}
```

**Query Parameters:**
- `severity` (optional): Filter by severity (CRITICAL, HIGH, MEDIUM, LOW)
- `state` (optional): Filter by state (ACTIVE, INACTIVE)
- `page` (optional): Page number, starts from 1 (default: 1)
- `page_size` (optional): Results per page (default: 100, max: 1000)

**Examples:**
```bash
# Get all vulnerabilities for LOB "Technology"
curl http://localhost:8000/vulnerabilities/by-lob/Technology

# Get only HIGH vulnerabilities for LOB "Finance" with pagination
curl "http://localhost:8000/vulnerabilities/by-lob/Finance?severity=HIGH&page=1&page_size=50"
```

### 5. Get Vulnerability by Finding ID
```
GET /vulnerabilities/{finding_id}
```

**Example:**
```bash
curl http://localhost:8000/vulnerabilities/abc123
```

### 6. Get Statistics
```
GET /statistics
```

Returns aggregated statistics across all vulnerabilities.

**Example:**
```bash
curl http://localhost:8000/statistics
```

### 7. List All Appcodes (Paginated)
```
GET /appcodes
```

**Query Parameters:**
- `page` (optional): Page number, starts from 1 (default: 1)
- `page_size` (optional): Results per page (default: 100, max: 1000)

Returns all unique appcodes with their vulnerability counts.

**Example:**
```bash
# Get first page of appcodes
curl http://localhost:8000/appcodes

# Get specific page with custom page size
curl "http://localhost:8000/appcodes?page=1&page_size=50"
```

### 8. List All LOBs (Paginated)
```
GET /lobs
```

**Query Parameters:**
- `page` (optional): Page number, starts from 1 (default: 1)
- `page_size` (optional): Results per page (default: 100, max: 1000)

Returns all unique LOBs with their vulnerability counts.

**Example:**
```bash
# Get first page of LOBs
curl http://localhost:8000/lobs

# Get specific page with custom page size
curl "http://localhost:8000/lobs?page=1&page_size=50"
```

## Interactive API Documentation

FastAPI automatically generates interactive API documentation:

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## Testing

Run the test script to verify all endpoints:

```bash
python test_api.py
```

Make sure the API is running before executing the test script.

## Deployment

### Docker Deployment
Create a `Dockerfile`:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "api:app", "--host", "0.0.0.0", "--port", "8000"]
```

Build and run:
```bash
docker build -t vulnerability-api .
docker run -p 8000:8000 -e ENVIRONMENT=prod vulnerability-api
```

### Cloud Run Deployment
```bash
gcloud run deploy vulnerability-api \
  --source . \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated
```

## Security Considerations

- Ensure proper GCP IAM permissions are configured
- Use authentication middleware for production deployments
- Consider rate limiting for public-facing APIs
- Use HTTPS in production environments
- Implement API key or OAuth2 authentication as needed

## Performance Considerations

- For large datasets, the `/statistics` endpoint may be slow as it scans all documents
- Consider implementing pagination for large result sets
- Use Firestore composite indexes for complex queries with multiple filters
