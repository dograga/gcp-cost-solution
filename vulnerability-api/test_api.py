"""Test script for the SCC Vulnerability API"""

import requests
import json
from typing import Optional

# API base URL
BASE_URL = "http://localhost:8000"


def print_response(response: requests.Response, title: str):
    """Pretty print API response"""
    print("\n" + "=" * 80)
    print(f"{title}")
    print("=" * 80)
    print(f"Status Code: {response.status_code}")
    
    if response.status_code == 200:
        try:
            data = response.json()
            print(json.dumps(data, indent=2))
        except:
            print(response.text)
    else:
        print(f"Error: {response.text}")
    print("=" * 80)


def test_root():
    """Test root endpoint"""
    response = requests.get(f"{BASE_URL}/")
    print_response(response, "ROOT ENDPOINT")


def test_health():
    """Test health check endpoint"""
    response = requests.get(f"{BASE_URL}/health")
    print_response(response, "HEALTH CHECK")


def test_list_appcodes():
    """Test list appcodes endpoint"""
    response = requests.get(f"{BASE_URL}/appcodes", params={"page": 1, "page_size": 10})
    print_response(response, "LIST APPCODES (Paginated)")
    
    # Return first appcode for further testing
    if response.status_code == 200:
        data = response.json()
        if data.get('appcodes') and len(data['appcodes']) > 0:
            return data['appcodes'][0]['appcode']
    return None


def test_list_lobs():
    """Test list LOBs endpoint"""
    response = requests.get(f"{BASE_URL}/lobs", params={"page": 1, "page_size": 10})
    print_response(response, "LIST LOBS (Paginated)")
    
    # Return first LOB for further testing
    if response.status_code == 200:
        data = response.json()
        if data.get('lobs') and len(data['lobs']) > 0:
            return data['lobs'][0]['lob']
    return None


def test_get_vulnerabilities_by_appcode(appcode: str):
    """Test get vulnerabilities by appcode"""
    # Test without filters - page 1
    response = requests.get(f"{BASE_URL}/vulnerabilities/by-appcode/{appcode}")
    print_response(response, f"VULNERABILITIES FOR APPCODE: {appcode} (Page 1)")
    
    # Test with severity filter and pagination
    response = requests.get(
        f"{BASE_URL}/vulnerabilities/by-appcode/{appcode}",
        params={"severity": "CRITICAL", "page": 1, "page_size": 10}
    )
    print_response(response, f"CRITICAL VULNERABILITIES FOR APPCODE: {appcode} (Paginated)")
    
    # Return first finding_id for further testing
    if response.status_code == 200:
        data = response.json()
        if data.get('vulnerabilities') and len(data['vulnerabilities']) > 0:
            return data['vulnerabilities'][0]['finding_id']
    return None


def test_get_vulnerabilities_by_lob(lob: str):
    """Test get vulnerabilities by LOB"""
    # Test without filters - page 1
    response = requests.get(f"{BASE_URL}/vulnerabilities/by-lob/{lob}")
    print_response(response, f"VULNERABILITIES FOR LOB: {lob} (Page 1)")
    
    # Test with severity filter and pagination
    response = requests.get(
        f"{BASE_URL}/vulnerabilities/by-lob/{lob}",
        params={"severity": "HIGH", "page": 1, "page_size": 10}
    )
    print_response(response, f"HIGH VULNERABILITIES FOR LOB: {lob} (Paginated)")


def test_get_vulnerability_by_id(finding_id: str):
    """Test get vulnerability by finding ID"""
    response = requests.get(f"{BASE_URL}/vulnerabilities/{finding_id}")
    print_response(response, f"VULNERABILITY DETAILS: {finding_id}")


def test_statistics():
    """Test statistics endpoint"""
    response = requests.get(f"{BASE_URL}/statistics")
    print_response(response, "VULNERABILITY STATISTICS")


def main():
    """Run all tests"""
    print("\n" + "=" * 80)
    print("SCC VULNERABILITY API - TEST SUITE")
    print("=" * 80)
    print(f"Testing API at: {BASE_URL}")
    print("Make sure the API is running before executing this script!")
    print("=" * 80)
    
    try:
        # Test basic endpoints
        test_root()
        test_health()
        
        # Test appcodes listing
        appcode = test_list_appcodes()
        
        # Test LOBs listing
        lob = test_list_lobs()
        
        if appcode:
            print(f"\nUsing appcode '{appcode}' for further testing...")
            
            # Test vulnerabilities by appcode
            finding_id = test_get_vulnerabilities_by_appcode(appcode)
            
            if finding_id:
                # Test individual vulnerability lookup
                test_get_vulnerability_by_id(finding_id)
        else:
            print("\nNo appcodes found in database. Skipping appcode-specific tests.")
            print("Make sure you have run the ingestion service first to populate data.")
        
        if lob:
            print(f"\nUsing LOB '{lob}' for further testing...")
            
            # Test vulnerabilities by LOB
            test_get_vulnerabilities_by_lob(lob)
        
        # Test statistics
        test_statistics()
        
        print("\n" + "=" * 80)
        print("TEST SUITE COMPLETED")
        print("=" * 80)
        
    except requests.exceptions.ConnectionError:
        print("\n" + "=" * 80)
        print("ERROR: Could not connect to API")
        print("=" * 80)
        print("Make sure the API is running:")
        print("  python api.py")
        print("  OR")
        print("  uvicorn api:app --reload")
        print("=" * 80)
    except Exception as e:
        print("\n" + "=" * 80)
        print(f"ERROR: {str(e)}")
        print("=" * 80)


if __name__ == "__main__":
    main()
