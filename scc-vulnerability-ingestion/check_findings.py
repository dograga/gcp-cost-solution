"""Script to check what findings exist in SCC"""

from google.cloud.securitycenter_v2 import SecurityCenterClient
from google.cloud.securitycenter_v2.types import ListFindingsRequest
import os
from collections import defaultdict

# Load environment
from dotenv import load_dotenv
load_dotenv('.env.dev')

org_id = os.environ.get('GCP_ORGANIZATION_ID')
print(f"Organization ID: {org_id}")

client = SecurityCenterClient()
parent = f"organizations/{org_id}/sources/-"

print("\n" + "="*80)
print("CHECKING FINDINGS IN SCC")
print("="*80)

# Test 1: Check all findings (no filter)
print("\n1. Checking ALL findings (no filter)...")
try:
    request = ListFindingsRequest(parent=parent, page_size=100)
    findings = client.list_findings(request=request)
    
    all_count = 0
    categories = defaultdict(int)
    states = defaultdict(int)
    sources = defaultdict(int)
    
    for finding_result in findings:
        all_count += 1
        finding = finding_result.finding
        
        # Count by category
        if hasattr(finding, 'category'):
            categories[finding.category] += 1
        
        # Count by state
        if hasattr(finding, 'state'):
            states[str(finding.state)] += 1
        
        # Count by source
        source_name = finding.name.split('/sources/')[1].split('/')[0] if '/sources/' in finding.name else 'unknown'
        sources[source_name] += 1
        
        if all_count >= 100:
            break
    
    print(f"   Total findings (first 100): {all_count}")
    
    if all_count > 0:
        print(f"\n   Breakdown by Category:")
        for cat, count in sorted(categories.items(), key=lambda x: x[1], reverse=True):
            print(f"     - {cat}: {count}")
        
        print(f"\n   Breakdown by State:")
        for state, count in sorted(states.items(), key=lambda x: x[1], reverse=True):
            print(f"     - {state}: {count}")
        
        print(f"\n   Top Sources:")
        for source, count in sorted(sources.items(), key=lambda x: x[1], reverse=True)[:5]:
            print(f"     - {source}: {count}")
    else:
        print("   ⚠️  No findings found at all!")
        
except Exception as e:
    print(f"   ✗ Error: {e}")

# Test 2: Check ACTIVE findings
print("\n2. Checking ACTIVE findings...")
try:
    request = ListFindingsRequest(
        parent=parent,
        filter='state="ACTIVE"',
        page_size=100
    )
    findings = client.list_findings(request=request)
    
    active_count = 0
    active_categories = defaultdict(int)
    
    for finding_result in findings:
        active_count += 1
        finding = finding_result.finding
        if hasattr(finding, 'category'):
            active_categories[finding.category] += 1
        
        if active_count >= 100:
            break
    
    print(f"   ACTIVE findings: {active_count}")
    
    if active_count > 0:
        print(f"   Categories:")
        for cat, count in sorted(active_categories.items(), key=lambda x: x[1], reverse=True):
            print(f"     - {cat}: {count}")
            
except Exception as e:
    print(f"   ✗ Error: {e}")

# Test 3: Check for VULNERABILITY category
print("\n3. Checking VULNERABILITY category...")
try:
    request = ListFindingsRequest(
        parent=parent,
        filter='category="VULNERABILITY"',
        page_size=100
    )
    findings = client.list_findings(request=request)
    
    vuln_count = 0
    vuln_states = defaultdict(int)
    
    for finding_result in findings:
        vuln_count += 1
        finding = finding_result.finding
        if hasattr(finding, 'state'):
            vuln_states[str(finding.state)] += 1
        
        if vuln_count >= 100:
            break
    
    print(f"   VULNERABILITY findings: {vuln_count}")
    
    if vuln_count > 0:
        print(f"   States:")
        for state, count in sorted(vuln_states.items(), key=lambda x: x[1], reverse=True):
            print(f"     - {state}: {count}")
            
except Exception as e:
    print(f"   ✗ Error: {e}")

# Test 4: Check combined filter
print("\n4. Checking ACTIVE + VULNERABILITY...")
try:
    request = ListFindingsRequest(
        parent=parent,
        filter='state="ACTIVE" AND category="VULNERABILITY"',
        page_size=100
    )
    findings = client.list_findings(request=request)
    
    combined_count = 0
    sample_findings = []
    
    for finding_result in findings:
        combined_count += 1
        if combined_count <= 3:
            sample_findings.append(finding_result.finding)
        
        if combined_count >= 100:
            break
    
    print(f"   ACTIVE + VULNERABILITY findings: {combined_count}")
    
    if combined_count > 0:
        print(f"\n   Sample findings:")
        for i, finding in enumerate(sample_findings, 1):
            print(f"\n   Finding {i}:")
            print(f"     Name: {finding.name}")
            print(f"     Category: {finding.category}")
            print(f"     State: {finding.state}")
            if hasattr(finding, 'severity'):
                print(f"     Severity: {finding.severity}")
            if hasattr(finding, 'finding_class'):
                print(f"     Finding Class: {finding.finding_class}")
            
except Exception as e:
    print(f"   ✗ Error: {e}")

# Test 5: Check specific vulnerability sources
print("\n5. Checking specific vulnerability sources...")
vuln_sources = [
    ("3207016158507101047", "Vulnerability Assessment"),
    ("10595432210225316038", "VM Manager"),
    ("535048477512538917", "Agentless Vulnerability Assessment"),
    ("2409562420650132255", "Integrated Vulnerability Scanner"),
]

for source_id, source_name in vuln_sources:
    try:
        source_parent = f"organizations/{org_id}/sources/{source_id}"
        request = ListFindingsRequest(
            parent=source_parent,
            filter='state="ACTIVE"',
            page_size=10
        )
        findings = client.list_findings(request=request)
        
        count = sum(1 for _ in findings)
        print(f"   {source_name}: {count} findings")
        
    except Exception as e:
        print(f"   {source_name}: Error - {e}")

print("\n" + "="*80)
print("SUMMARY")
print("="*80)
print("""
If you see 0 findings:
1. Security Command Center may not be fully enabled
2. No vulnerabilities have been detected yet
3. Vulnerability scanning may need to be enabled on resources
4. Findings may have been resolved or are in INACTIVE state

To enable vulnerability scanning:
- Enable VM Manager for Compute Engine instances
- Enable Container Scanning for GKE
- Enable Web Security Scanner for web applications
- Wait for initial scans to complete (can take hours)

Check SCC Console:
https://console.cloud.google.com/security/command-center/findings?organizationId={org_id}
""".format(org_id=org_id))
