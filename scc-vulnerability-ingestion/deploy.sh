#!/bin/bash

# Deployment script for SCC Vulnerability Ingestion Service

set -e

# Configuration
PROJECT_ID=${GCP_PROJECT_ID:-"your-project-id"}
REGION=${REGION:-"asia-southeast1"}
SERVICE_NAME="scc-ingestion"
SERVICE_ACCOUNT="${SERVICE_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"
IMAGE_NAME="gcr.io/${PROJECT_ID}/${SERVICE_NAME}:latest"
ENVIRONMENT=${ENVIRONMENT:-"prod"}

echo "=========================================="
echo "SCC Vulnerability Ingestion Deployment"
echo "=========================================="
echo "Project ID: ${PROJECT_ID}"
echo "Region: ${REGION}"
echo "Service Name: ${SERVICE_NAME}"
echo "Environment: ${ENVIRONMENT}"
echo "=========================================="

# Step 1: Create service account if it doesn't exist
echo "Step 1: Creating service account..."
gcloud iam service-accounts describe ${SERVICE_ACCOUNT} --project=${PROJECT_ID} 2>/dev/null || \
gcloud iam service-accounts create ${SERVICE_NAME} \
    --display-name="SCC Vulnerability Ingestion Service" \
    --project=${PROJECT_ID}

# Step 2: Grant IAM permissions
echo "Step 2: Granting IAM permissions..."

# SCC permissions (organization level)
echo "  - Granting Security Center Findings Viewer role..."
gcloud organizations add-iam-policy-binding ${GCP_ORGANIZATION_ID} \
    --member="serviceAccount:${SERVICE_ACCOUNT}" \
    --role="roles/securitycenter.findingsViewer" \
    --condition=None

# Firestore permissions
echo "  - Granting Datastore User role..."
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
    --member="serviceAccount:${SERVICE_ACCOUNT}" \
    --role="roles/datastore.user"

# Cloud Run Invoker (for Cloud Scheduler)
echo "  - Granting Cloud Run Invoker role..."
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
    --member="serviceAccount:${SERVICE_ACCOUNT}" \
    --role="roles/run.invoker"

# Step 3: Build Docker image
echo "Step 3: Building Docker image..."
gcloud builds submit --tag ${IMAGE_NAME} --project=${PROJECT_ID}

# Step 4: Deploy to Cloud Run
echo "Step 4: Deploying to Cloud Run..."
gcloud run deploy ${SERVICE_NAME} \
    --image ${IMAGE_NAME} \
    --platform managed \
    --region ${REGION} \
    --memory 2Gi \
    --cpu 2 \
    --timeout 1800 \
    --set-env-vars ENVIRONMENT=${ENVIRONMENT} \
    --service-account ${SERVICE_ACCOUNT} \
    --no-allow-unauthenticated \
    --project=${PROJECT_ID}

# Get Cloud Run URL
SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
    --platform managed \
    --region ${REGION} \
    --format 'value(status.url)' \
    --project=${PROJECT_ID})

echo "Service URL: ${SERVICE_URL}"

# Step 5: Create Cloud Scheduler job
echo "Step 5: Creating Cloud Scheduler job..."

# Delete existing job if it exists
gcloud scheduler jobs delete ${SERVICE_NAME} \
    --location=${REGION} \
    --project=${PROJECT_ID} \
    --quiet 2>/dev/null || true

# Create new job
gcloud scheduler jobs create http ${SERVICE_NAME} \
    --schedule="0 */6 * * *" \
    --uri="${SERVICE_URL}/run" \
    --http-method=POST \
    --oidc-service-account-email=${SERVICE_ACCOUNT} \
    --location=${REGION} \
    --time-zone="Asia/Singapore" \
    --attempt-deadline="1800s" \
    --max-retry-attempts=3 \
    --project=${PROJECT_ID}

echo "=========================================="
echo "Deployment Complete!"
echo "=========================================="
echo "Service URL: ${SERVICE_URL}"
echo "Scheduler: Every 6 hours"
echo "Next run: Check Cloud Scheduler console"
echo "=========================================="
echo ""
echo "To manually trigger the job:"
echo "gcloud scheduler jobs run ${SERVICE_NAME} --location=${REGION} --project=${PROJECT_ID}"
echo ""
echo "To view logs:"
echo "gcloud logging read \"resource.type=cloud_run_revision AND resource.labels.service_name=${SERVICE_NAME}\" --limit 50 --project=${PROJECT_ID}"
