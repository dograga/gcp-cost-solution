"""Test script to verify SCC API v2 connectivity"""

from google.cloud.securitycenter_v2 import SecurityCenterClient
from google.cloud.securitycenter_v2.types import ListFindingsRequest, ListSourcesRequest
import os

# Load environment
from dotenv import load_dotenv
load_dotenv('.env.dev')

org_id = os.environ.get('GCP_ORGANIZATION_ID')
print(f"Organization ID: {org_id}")

# Initialize client
client = SecurityCenterClient()
print("✓ Client initialized")

# First, list available sources
print("\n=== Listing Available Sources ===")
try:
    sources_request = ListSourcesRequest(
        parent=f"organizations/{org_id}"
    )
    sources = client.list_sources(request=sources_request)
    source_list = []
    for source in sources:
        source_id = source.name.split('/')[-1]
        source_list.append(source_id)
        print(f"  Source: {source.name}")
        print(f"    ID: {source_id}")
        print(f"    Display Name: {source.display_name}")
        print(f"    Description: {source.description}")
    
    if not source_list:
        print("  ✗ No sources found!")
        print("  Note: You may need to enable Security Command Center or check permissions")
        exit(1)
    
    print(f"\n✓ Found {len(source_list)} source(s)")
    
    # Use the first source for testing, or use "-" to search all
    test_source_id = source_list[0] if source_list else None
    
except Exception as e:
    print(f"✗ Error listing sources: {e}")
    print("\nTrying with wildcard '-' for source...")
    test_source_id = "-"

# Test different parent formats with actual source ID
if test_source_id:
    parent_formats = [
        f"organizations/{org_id}/sources/{test_source_id}/locations/-",
        f"organizations/{org_id}/sources/{test_source_id}",
    ]
    
    print(f"\n=== Testing Parent Path Formats with Source ID: {test_source_id} ===")
    for i, parent in enumerate(parent_formats, 1):
        print(f"\nTest {i}: Parent = {parent}")
        try:
            request = ListFindingsRequest(
                parent=parent,
                page_size=2
            )
            findings = client.list_findings(request=request)
            count = 0
            for finding in findings:
                count += 1
                print(f"  ✓ Finding: {finding.finding.name}")
                if count >= 2:
                    break
            print(f"  ✓ SUCCESS with parent: {parent}")
            working_parent = parent
            break
        except Exception as e:
            print(f"  ✗ Failed: {e}")
else:
    print("\n✗ No source ID available for testing")
    exit(1)

# Use the working parent for remaining tests
if 'working_parent' not in locals():
    print("\n✗ No working parent path found!")
    exit(1)

print(f"\n=== Using working parent: {working_parent} ===")

# Test 1: List findings without filter
print("\n=== Test 1: List findings without filter ===")
parent = working_parent
print(f"Parent: {parent}")

try:
    request = ListFindingsRequest(
        parent=parent,
        page_size=5
    )
    print(f"Request: {request}")
    
    findings = client.list_findings(request=request)
    count = 0
    for finding in findings:
        count += 1
        print(f"  Finding {count}: {finding.finding.name}")
        if count >= 5:
            break
    
    print(f"✓ Successfully fetched {count} findings without filter")
except Exception as e:
    print(f"✗ Error: {e}")

# Test 2: List findings with state filter
print("\n=== Test 2: List findings with state filter ===")
try:
    request = ListFindingsRequest(
        parent=parent,
        filter='state="ACTIVE"',
        page_size=5
    )
    print(f"Filter: state=\"ACTIVE\"")
    
    findings = client.list_findings(request=request)
    count = 0
    for finding in findings:
        count += 1
        print(f"  Finding {count}: {finding.finding.name}")
        if count >= 5:
            break
    
    print(f"✓ Successfully fetched {count} findings with state filter")
except Exception as e:
    print(f"✗ Error: {e}")

# Test 3: List findings with category filter
print("\n=== Test 3: List findings with category filter ===")
try:
    request = ListFindingsRequest(
        parent=parent,
        filter='category="VULNERABILITY"',
        page_size=5
    )
    print(f"Filter: category=\"VULNERABILITY\"")
    
    findings = client.list_findings(request=request)
    count = 0
    for finding in findings:
        count += 1
        print(f"  Finding {count}: {finding.finding.name}")
        print(f"    Category: {finding.finding.category}")
        if count >= 5:
            break
    
    print(f"✓ Successfully fetched {count} findings with category filter")
except Exception as e:
    print(f"✗ Error: {e}")

# Test 4: List findings with combined filter
print("\n=== Test 4: List findings with combined filter ===")
try:
    request = ListFindingsRequest(
        parent=parent,
        filter='state="ACTIVE" AND category="VULNERABILITY"',
        page_size=5
    )
    print(f"Filter: state=\"ACTIVE\" AND category=\"VULNERABILITY\"")
    
    findings = client.list_findings(request=request)
    count = 0
    for finding in findings:
        count += 1
        print(f"  Finding {count}: {finding.finding.name}")
        print(f"    State: {finding.finding.state}")
        print(f"    Category: {finding.finding.category}")
        if count >= 5:
            break
    
    print(f"✓ Successfully fetched {count} findings with combined filter")
except Exception as e:
    print(f"✗ Error: {e}")

print("\n=== Tests Complete ===")
