"""Helper script to setup project mapping in Firestore or Redis"""

import asyncio
import logging
import sys
import csv
from datastore_factory import create_datastore
import config

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


async def setup_from_csv(csv_file: str):
    """
    Setup project mapping from CSV file.
    
    CSV format:
    projectid,appcode,lob
    my-project-123,payment-service,finance
    analytics-456,analytics-platform,data
    """
    logger.info(f"Loading project mapping from {csv_file}")
    
    datastore = create_datastore()
    count = 0
    
    try:
        with open(csv_file, 'r') as f:
            reader = csv.DictReader(f)
            
            for row in reader:
                project_id = row.get('projectid')
                appcode = row.get('appcode')
                lob = row.get('lob')
                
                if not project_id or not appcode or not lob:
                    logger.warning(f"Skipping invalid row: {row}")
                    continue
                
                # For Firestore
                if config.DATASTORE_TYPE == 'firestore':
                    from google.cloud import firestore
                    db = firestore.Client(project=config.GCP_PROJECT_ID)
                    doc_ref = db.collection(config.FIRESTORE_COLLECTION_PROJECT_MAPPING).document(project_id)
                    doc_ref.set({
                        'projectid': project_id,
                        'appcode': appcode,
                        'lob': lob
                    })
                    logger.info(f"Added to Firestore: {project_id} -> {appcode}/{lob}")
                
                # For Redis
                elif config.DATASTORE_TYPE == 'redis':
                    from redis_datastore import RedisDatastore
                    redis_ds = RedisDatastore()
                    await redis_ds.set_project_mapping(project_id, appcode, lob)
                    logger.info(f"Added to Redis: {project_id} -> {appcode}/{lob}")
                
                count += 1
        
        logger.info(f"Successfully loaded {count} project mappings")
        
    except Exception as e:
        logger.error(f"Error loading project mapping: {e}")
        raise
    
    finally:
        await datastore.close()


async def setup_sample_data():
    """Setup sample project mapping data"""
    logger.info("Setting up sample project mapping data")
    
    sample_data = [
        {'projectid': 'payment-prod-123', 'appcode': 'payment-service', 'lob': 'finance'},
        {'projectid': 'analytics-prod-456', 'appcode': 'analytics-platform', 'lob': 'data'},
        {'projectid': 'web-frontend-789', 'appcode': 'web-application', 'lob': 'digital'},
        {'projectid': 'api-gateway-012', 'appcode': 'api-gateway', 'lob': 'platform'},
        {'projectid': 'ml-training-345', 'appcode': 'ml-platform', 'lob': 'data'},
    ]
    
    datastore = create_datastore()
    
    try:
        for data in sample_data:
            project_id = data['projectid']
            appcode = data['appcode']
            lob = data['lob']
            
            # For Firestore
            if config.DATASTORE_TYPE == 'firestore':
                from google.cloud import firestore
                db = firestore.Client(project=config.GCP_PROJECT_ID)
                doc_ref = db.collection(config.FIRESTORE_COLLECTION_PROJECT_MAPPING).document(project_id)
                doc_ref.set(data)
                logger.info(f"Added to Firestore: {project_id} -> {appcode}/{lob}")
            
            # For Redis
            elif config.DATASTORE_TYPE == 'redis':
                from redis_datastore import RedisDatastore
                redis_ds = RedisDatastore()
                await redis_ds.set_project_mapping(project_id, appcode, lob)
                logger.info(f"Added to Redis: {project_id} -> {appcode}/{lob}")
        
        logger.info(f"Successfully loaded {len(sample_data)} sample project mappings")
        
    except Exception as e:
        logger.error(f"Error loading sample data: {e}")
        raise
    
    finally:
        await datastore.close()


async def verify_mapping():
    """Verify project mapping in datastore"""
    logger.info("Verifying project mapping...")
    
    datastore = create_datastore()
    
    try:
        mapping = await datastore.get_project_mapping()
        
        logger.info(f"Found {len(mapping)} project mappings:")
        for project_id, data in mapping.items():
            logger.info(f"  {project_id}: {data['appcode']} / {data['lob']}")
        
    except Exception as e:
        logger.error(f"Error verifying mapping: {e}")
        raise
    
    finally:
        await datastore.close()


async def main():
    """Main execution"""
    if len(sys.argv) < 2:
        print("Usage:")
        print("  python setup_project_mapping.py sample          # Load sample data")
        print("  python setup_project_mapping.py csv <file.csv>  # Load from CSV")
        print("  python setup_project_mapping.py verify          # Verify mapping")
        sys.exit(1)
    
    command = sys.argv[1]
    
    if command == 'sample':
        await setup_sample_data()
    
    elif command == 'csv':
        if len(sys.argv) < 3:
            print("Error: CSV file path required")
            sys.exit(1)
        csv_file = sys.argv[2]
        await setup_from_csv(csv_file)
    
    elif command == 'verify':
        await verify_mapping()
    
    else:
        print(f"Unknown command: {command}")
        sys.exit(1)


if __name__ == "__main__":
    asyncio.run(main())
