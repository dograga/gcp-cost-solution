"""View raw vulnerability findings from SCC without any processing"""

from google.cloud.securitycenter_v2 import SecurityCenterClient
from google.cloud.securitycenter_v2.types import ListFindingsRequest
from google.protobuf.json_format import MessageToDict
import os
import json

# Load environment
from dotenv import load_dotenv
load_dotenv('.env.dev')

org_id = os.environ.get('GCP_ORGANIZATION_ID')
print(f"Organization ID: {org_id}\n")

# Initialize client
client = SecurityCenterClient()
parent = f"organizations/{org_id}/sources/-"

# Fetch findings with the same filter as main script
filter_str = 'state="ACTIVE" AND findingClass="VULNERABILITY"'
print(f"Filter: {filter_str}")
print(f"Parent: {parent}\n")

request = ListFindingsRequest(
    parent=parent,
    filter=filter_str,
    page_size=5  # Just get first 5 for viewing
)

print("="*100)
print("FETCHING RAW VULNERABILITY FINDINGS")
print("="*100)

try:
    findings = client.list_findings(request=request)
    
    count = 0
    for finding_result in findings:
        count += 1
        
        print(f"\n{'='*100}")
        print(f"FINDING #{count}")
        print(f"{'='*100}\n")
        
        # Convert protobuf to dict for better readability
        finding_dict = MessageToDict(finding_result.finding._pb)
        resource_dict = MessageToDict(finding_result.resource._pb)
        
        print("--- FINDING OBJECT ---")
        print(json.dumps(finding_dict, indent=2))
        
        print("\n--- RESOURCE OBJECT ---")
        print(json.dumps(resource_dict, indent=2))
        
        print("\n--- KEY FIELDS ---")
        finding = finding_result.finding
        print(f"Name: {finding.name}")
        print(f"State: {finding.state}")
        print(f"Category: {finding.category}")
        print(f"Severity: {finding.severity}")
        print(f"Finding Class: {finding.finding_class}")
        print(f"Create Time: {finding.create_time}")
        print(f"Event Time: {finding.event_time}")
        
        # Check for vulnerability details
        if hasattr(finding, 'vulnerability'):
            print(f"\n--- VULNERABILITY DETAILS ---")
            vuln = finding.vulnerability
            print(f"CVE: {vuln.cve.id if hasattr(vuln, 'cve') else 'N/A'}")
            
            if hasattr(vuln, 'offending_package'):
                print(f"Offending Package: {vuln.offending_package.package_name}")
                print(f"Package Version: {vuln.offending_package.package_version}")
            
            if hasattr(vuln, 'fixed_package'):
                print(f"Fixed Package: {vuln.fixed_package.package_name}")
                print(f"Fixed Version: {vuln.fixed_package.package_version}")
        
        # Check for Kubernetes details
        if hasattr(finding, 'kubernetes'):
            print(f"\n--- KUBERNETES DETAILS ---")
            k8s = finding.kubernetes
            
            if hasattr(k8s, 'pods') and k8s.pods:
                print(f"Pods: {len(k8s.pods)}")
                for pod in k8s.pods[:2]:  # Show first 2 pods
                    print(f"  - Pod: {pod.name}")
                    print(f"    Namespace: {pod.ns}")
                    if hasattr(pod, 'containers') and pod.containers:
                        print(f"    Containers: {len(pod.containers)}")
                        for container in pod.containers[:2]:
                            print(f"      - {container.name}: {container.image}")
            
            if hasattr(k8s, 'objects') and k8s.objects:
                print(f"Objects: {len(k8s.objects)}")
                for obj in k8s.objects[:2]:
                    print(f"  - {obj.kind}: {obj.name}")
        
        # Resource details
        print(f"\n--- RESOURCE DETAILS ---")
        resource = finding_result.resource
        print(f"Resource Name: {resource.name}")
        print(f"Display Name: {resource.display_name}")
        print(f"Type: {resource.type}")
        print(f"Project: {resource.project}")
        print(f"Project Display Name: {resource.project_display_name}")
        
        if count >= 5:
            break
    
    print(f"\n{'='*100}")
    print(f"Total findings fetched: {count}")
    print(f"{'='*100}\n")
    
    if count == 0:
        print("⚠️  No findings found with the current filter!")
        print("\nTry these alternatives:")
        print("1. Remove filter: SCC_FINDING_FILTER=")
        print("2. Check only ACTIVE: SCC_FINDING_FILTER=state=\"ACTIVE\"")
        print("3. Check specific category: SCC_FINDING_FILTER=category=\"SOFTWARE_VULNERABILITY\"")

except Exception as e:
    print(f"✗ Error: {e}")
    import traceback
    traceback.print_exc()

print("\n" + "="*100)
print("TIPS")
print("="*100)
print("""
To save output to file:
  python view_raw_findings.py > raw_findings.json

To view specific fields:
  - finding.vulnerability: CVE and package details
  - finding.kubernetes: K8s pod/container info
  - finding.source_properties: Additional metadata
  - resource: GCP resource details

To compare with DB:
  1. Run this script to see raw data
  2. Run main.py to ingest
  3. Query Firestore to see stored data
  4. Compare the two
""")
