"""Client for fetching vulnerability findings from GCP Security Command Center"""

import logging
from typing import List, Dict, Any, Iterator
from google.cloud import securitycenter
import config

logger = logging.getLogger(__name__)


class SCCClient:
    """Client for interacting with GCP Security Command Center"""
    
    def __init__(self):
        self.client = securitycenter.SecurityCenterClient()
        self.org_name = f"organizations/{config.GCP_ORGANIZATION_ID}"
        logger.info(f"Initialized SCC client for organization: {self.org_name}")
    
    def fetch_vulnerability_findings(self) -> Iterator[Dict[str, Any]]:
        """
        Fetch vulnerability findings from SCC.
        Yields findings one at a time for memory efficiency.
        
        Yields:
            Dictionary containing finding data
        """
        request = securitycenter.ListFindingsRequest(
            parent=f"{self.org_name}/sources/-",
            filter=config.SCC_FINDING_FILTER,
            page_size=config.SCC_PAGE_SIZE
        )
        
        logger.info(f"Fetching findings with filter: {config.SCC_FINDING_FILTER}")
        
        try:
            findings_iterator = self.client.list_findings(request=request)
            
            count = 0
            for finding_result in findings_iterator:
                finding = finding_result.finding
                resource = finding_result.resource
                
                # Extract relevant data
                finding_data = self._extract_finding_data(finding, resource)
                
                count += 1
                if count % 1000 == 0:
                    logger.info(f"Fetched {count} findings from SCC...")
                
                yield finding_data
            
            logger.info(f"Total findings fetched: {count}")
            
        except Exception as e:
            logger.error(f"Error fetching findings from SCC: {e}")
            raise
    
    def _extract_finding_data(self, finding, resource) -> Dict[str, Any]:
        """
        Extract and structure finding data.
        
        Args:
            finding: SCC Finding object
            resource: SCC Resource object
            
        Returns:
            Dictionary with structured finding data
        """
        # Extract project ID from resource name
        # Format: //cloudresourcemanager.googleapis.com/projects/123456
        project_id = None
        if resource.name:
            parts = resource.name.split('/')
            if 'projects' in parts:
                idx = parts.index('projects')
                if idx + 1 < len(parts):
                    project_id = parts[idx + 1]
        
        # Extract vulnerability details
        vulnerability = finding.vulnerability if hasattr(finding, 'vulnerability') else None
        
        cve = None
        cvss_score = None
        severity = None
        
        if vulnerability:
            if hasattr(vulnerability, 'cve') and vulnerability.cve:
                cve = vulnerability.cve.id if hasattr(vulnerability.cve, 'id') else None
                if hasattr(vulnerability.cve, 'cvssv3'):
                    cvss_score = vulnerability.cve.cvssv3.base_score if hasattr(vulnerability.cve.cvssv3, 'base_score') else None
            
            severity = finding.severity.name if hasattr(finding, 'severity') else None
        
        return {
            'finding_id': finding.name.split('/')[-1],  # Extract ID from full name
            'finding_name': finding.name,
            'category': finding.category,
            'state': finding.state.name if hasattr(finding, 'state') else 'UNKNOWN',
            'severity': severity or (finding.severity.name if hasattr(finding, 'severity') else 'UNKNOWN'),
            'resource_name': resource.name,
            'resource_display_name': resource.display_name,
            'resource_type': resource.type,
            'project_id': project_id,
            'cve': cve,
            'cvss_score': cvss_score,
            'create_time': finding.create_time.isoformat() if hasattr(finding, 'create_time') else None,
            'event_time': finding.event_time.isoformat() if hasattr(finding, 'event_time') else None,
            'source_properties': dict(finding.source_properties) if hasattr(finding, 'source_properties') else {},
            # These will be enriched later
            'appcode': None,
            'lob': None
        }
